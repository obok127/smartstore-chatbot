<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartStore FAQ RAG Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Smooth scroll for chat area */
    #chat { scroll-behavior: smooth; }
    .msg p { white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b">
      <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-[#2DB400] rounded flex items-center justify-center">
            <span class="text-white font-bold text-lg">N</span>
          </div>
          <h1 class="text-lg font-semibold">ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ FAQ ì±—ë´‡</h1>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <!-- ê°œë°œì ì„¤ì • ì œê±° - í”„ë¡œë•ì…˜ìš© -->
        </div>
      </div>
    </header>

    <!-- Chat -->
    <main class="flex-1">
      <div class="mx-auto max-w-3xl px-4 py-6">
        <div id="chat" class="bg-white border rounded-xl p-4 h-[75vh] overflow-y-auto space-y-4">
          <div class="msg flex gap-3">
            <div class="shrink-0 w-8 h-8 rounded-full bg-[#2DB400] text-white flex items-center justify-center">B</div>
            <div class="bg-green-50 text-gray-900 rounded-2xl px-4 py-2 max-w-[80%]">
              <p class="leading-relaxed mb-3">ì•ˆë…•í•˜ì„¸ìš”! ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ FAQ ì „ìš© ì±—ë´‡ì…ë‹ˆë‹¤.<br>ë°”ë¡œ ì´ë ‡ê²Œ ë¬¼ì–´ë³´ì„¸ìš”:</p>
              <div class="flex flex-wrap gap-2">
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="ë¯¸ì„±ë…„ìë„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ë¥¼ ê°œì„¤í•  ìˆ˜ ìˆë‚˜ìš”?">ë¯¸ì„±ë…„ìë„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ë¥¼ ê°œì„¤í•  ìˆ˜ ìˆë‚˜ìš”?</button>
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="ìƒí’ˆ ë“±ë¡ì€ ì–´ë–¤ ìˆœì„œë¡œ í•˜ë‚˜ìš”?">ìƒí’ˆ ë“±ë¡ì€ ì–´ë–¤ ìˆœì„œë¡œ í•˜ë‚˜ìš”?</button>
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="ì •ì‚° ì£¼ê¸°/ìˆ˜ìˆ˜ë£ŒëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?">ì •ì‚° ì£¼ê¸°/ìˆ˜ìˆ˜ë£ŒëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Composer -->
        <form id="composer" class="mt-4 flex gap-2">
          <input id="message" class="flex-1 border rounded-xl px-4 py-3" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ë¯¸ì„±ë…„ìë„ íŒë§¤ íšŒì› ë“±ë¡ì´ ê°€ëŠ¥í•œê°€ìš”?" autocomplete="off" maxlength="500" />
          <button class="px-5 py-3 rounded-xl bg-[#2DB400] text-white font-medium">ë³´ë‚´ê¸°</button>
        </form>

      </div>
    </main>

    <footer class="border-t bg-white">
      <div class="mx-auto max-w-3xl px-4 py-3 text-xs text-gray-500 text-center">
        ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ FAQ ì±—ë´‡ â€¢ AI ê¸°ë°˜ ì§€ëŠ¥í˜• ìƒë‹´ ì„œë¹„ìŠ¤
      </div>
    </footer>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('composer');
    const inputEl = document.getElementById('message');

    // ê³ ì •ëœ API Base URL ì‚¬ìš©
    const API_BASE = 'http://localhost:8000';

    let conversationId = localStorage.getItem('conversationId');
    if (!conversationId) {
      conversationId = crypto.randomUUID();
      localStorage.setItem('conversationId', conversationId);
    }

    // Quick question buttons handler (for both initial and dynamic buttons)
    function setupQuickButtons() {
      document.querySelectorAll('[data-quick-q]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const q = btn.getAttribute('data-quick-q') || '';
          if (!q) return;
          inputEl.value = q;
          formEl.dispatchEvent(new Event('submit'));
        });
      });
    }
    
    // Setup initial quick buttons
    setupQuickButtons();

    function appendBubble(role, html) {
      const wrap = document.createElement('div');
      // âœ… w-full + items-end ë¡œ ìˆ˜ì§ í•˜ë‹¨ ì •ë ¬, gap ìœ ì§€
      wrap.className = 'msg flex w-full items-end gap-3';

      const avatar = document.createElement('div');
      avatar.className = 'shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white';

      const body = document.createElement('div');
      body.className = 'rounded-2xl px-4 py-2 max-w-[85%] break-words';

      if (role === 'user') {
        // âœ… ì˜¤ë¥¸ìª½ ê³ ì •: ì „ì²´ ë˜í¼ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°€ì°© + ì—­ë°©í–¥ í”Œë ‰ìŠ¤
        wrap.classList.add('ml-auto', 'flex-row-reverse'); // (justify-end ì œê±°)
        avatar.textContent = 'U';
        avatar.classList.add('bg-gray-800');
        body.classList.add('bg-gray-100');
      } else {
        avatar.textContent = 'B';
        avatar.classList.add('bg-[#2DB400]');
        body.classList.add('bg-green-50');
      }

      const p = document.createElement('p');
      p.className = 'leading-relaxed break-words';
      if (role === 'user') p.classList.add('text-right');
      p.innerHTML = renderMarkdown(html || ''); // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©
      body.appendChild(p);

      // âœ… ì‚¬ìš©ìì¼ ë•Œ: ë²„ë¸”ì„ ë¨¼ì €, ì•„ë°”íƒ€ë¥¼ ë‚˜ì¤‘ì— ì¶”ê°€ â†’ row-reverseì—ì„œ ë²„ë¸”ì´ ìš°ì¸¡ ëì— ê³ ì •
      if (role === 'user') {
        wrap.appendChild(body);
        wrap.appendChild(avatar);
      } else {
        wrap.appendChild(avatar);
        wrap.appendChild(body);
      }

      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
      return { wrap, body, p };
    }

    function sanitize(text) {
      // Basic escape for HTML special chars
      return text
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function renderMarkdown(text) {
      // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
      return text
        // ë³¼ë“œì²´: **text** -> <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // ì´íƒ¤ë¦­: *text* -> <em>text</em>
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // ì¤„ë°”ê¿ˆ: \n -> <br>
        .replace(/\n/g, '<br>');
    }

    function extractBlocks(text) {
      // Extract optional <followups> and <citations> custom blocks from the final text
      const followRe = /<followups>[\s\S]*?<\/followups>/i;
      const citsRe = /<citations>[\s\S]*?<\/citations>/i;

      const fMatch = text.match(followRe);
      const cMatch = text.match(citsRe);

      let main = text.replace(followRe, '').replace(citsRe, '').trim();
      let followups = [];
      let citations = [];

      if (fMatch) {
        const lines = fMatch[0]
          .replace(/<\/?followups>/gi, '')
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);
        // keep only bullet lines
        followups = lines
          .filter(s => s.startsWith('-'))
          .map(s => s.replace(/^-[\s]*/, ''))
          .filter(Boolean)
          .slice(0, 4);
      }

      if (cMatch) {
        const lines = cMatch[0]
          .replace(/<\/?citations>/gi, '')
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);
        citations = lines
          .filter(s => s.startsWith('-'))
          .map(s => {
            // format: - (ì œëª©) (URL)
            const m = s.match(/^-[\s]*\((.*?)\)[\s]*\((https?:[^\s)]+)\)/);
            if (m) return { title: m[1], url: m[2] };
            return null;
          })
          .filter(Boolean)
          .slice(0, 3);
      }

      return { main, followups, citations };
    }

    async function sendMessage(ev) {
      ev.preventDefault();
      const msg = inputEl.value.trim();
      if (!msg) return;

      // Show user bubble
      appendBubble('user', sanitize(msg));
      inputEl.value = '';

      // Create assistant bubble placeholder with loading message
      const { body, p } = appendBubble('assistant', 'ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
      const extra = document.createElement('div');
      extra.className = 'text-xs text-gray-600 mt-2 space-y-2';
      body.appendChild(extra);
      
      // íˆ´ ì´ë²¤íŠ¸ë¥¼ ìœ„í•œ ë³€ìˆ˜
      let toolData = null;

      const res = await fetch(`${API_BASE}/chat/stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversation_id: conversationId, message: msg })
      });

      if (!res.ok || !res.body) {
        p.innerText = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
        return;
      }

      // Clear loading message when streaming starts
      p.textContent = '';

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';
      let fullText = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        // SSE chunks are separated by \n\n
        const parts = buffer.split('\n\n');
        buffer = parts.pop() || '';
        for (const part of parts) {
          const lines = part.split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const payload = JSON.parse(line.slice(6));
                if (payload && payload.type === 'token') {
                  fullText += payload.content || '';
                  p.innerHTML = renderMarkdown(fullText); // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©
                  chatEl.scrollTop = chatEl.scrollHeight;
                }
              } catch {}
            } else if (line.startsWith('event: tool')) {
              // íˆ´ ì´ë²¤íŠ¸ ì²˜ë¦¬
              const nextLine = lines[lines.indexOf(line) + 1];
              if (nextLine && nextLine.startsWith('data: ')) {
                try {
                  toolData = JSON.parse(nextLine.slice(6));
                } catch {}
              }
            }
          }
        }
      }

      // Post-process blocks: followups & citations
      const { main, followups, citations } = extractBlocks(fullText);
      p.innerHTML = renderMarkdown(main || fullText); // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ìœ ì§€

      // Render followups
      if (followups.length) {
        const wrap = document.createElement('div');
        wrap.className = 'flex flex-wrap gap-2';
        for (const f of followups) {
          const btn = document.createElement('button');
          btn.className = 'px-2.5 py-1.5 rounded-full border bg-white hover:bg-gray-50';
          btn.textContent = f;
          btn.addEventListener('click', () => {
            inputEl.value = f;
            formEl.dispatchEvent(new Event('submit'));
          });
          wrap.appendChild(btn);
        }
        extra.appendChild(wrap);
      }

      // Render tool button (ë„ì›€ë§ ê²€ìƒ‰)
      if (toolData && toolData.tool === 'open_help_search') {
        const toolDiv = document.createElement('div');
        toolDiv.className = 'mt-4 p-3 border rounded bg-gray-50 flex items-center gap-3';
        
        const link = document.createElement('a');
        link.href = toolData.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.className = 'px-3 py-1 border rounded bg-blue-500 text-white hover:bg-blue-600';
        link.textContent = `ğŸ” ë„ì›€ë§ì—ì„œ '${toolData.keyword}' ê²€ìƒ‰`;
        link.title = `ë„ì›€ë§ì—ì„œ '${toolData.keyword}' ê²€ìƒ‰`;
        
        const category = document.createElement('span');
        category.className = 'text-xs opacity-70';
        category.textContent = `ì¹´í…Œê³ ë¦¬No: ${toolData.categoryNo}`;
        
        toolDiv.appendChild(link);
        toolDiv.appendChild(category);
        extra.appendChild(toolDiv);
      }

      // Render citations
      if (citations.length) {
        const list = document.createElement('ul');
        list.className = 'list-disc ml-5';
        for (const c of citations) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = c.url;
          a.target = '_blank';
          a.rel = 'noreferrer';
          a.className = 'text-blue-700 underline';
          a.textContent = c.title || c.url;
          li.appendChild(a);
          list.appendChild(li);
        }
        const title = document.createElement('div');
        title.className = 'mt-2 font-medium';
        title.textContent = 'ì°¸ê³ :';
        extra.appendChild(title);
        extra.appendChild(list);
      }
    }

    formEl.addEventListener('submit', sendMessage);
  </script>
</body>
</html>
