<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartStore FAQ RAG Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Smooth scroll for chat area */
    #chat { scroll-behavior: smooth; }
    .msg p { white-space: pre-wrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b">
      <div class="mx-auto max-w-3xl px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-[#2DB400] rounded flex items-center justify-center">
            <span class="text-white font-bold text-lg">N</span>
          </div>
          <h1 class="text-lg font-semibold">네이버 스마트스토어 FAQ 챗봇</h1>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <!-- 개발자 설정 제거 - 프로덕션용 -->
        </div>
      </div>
    </header>

    <!-- Chat -->
    <main class="flex-1">
      <div class="mx-auto max-w-3xl px-4 py-6">
        <div id="chat" class="bg-white border rounded-xl p-4 h-[75vh] overflow-y-auto space-y-4">
          <div class="msg flex gap-3">
            <div class="shrink-0 w-8 h-8 rounded-full bg-[#2DB400] text-white flex items-center justify-center">B</div>
            <div class="bg-green-50 text-gray-900 rounded-2xl px-4 py-2 max-w-[80%]">
              <p class="leading-relaxed mb-3">안녕하세요! 스마트스토어 FAQ 전용 챗봇입니다.<br>바로 이렇게 물어보세요:</p>
              <div class="flex flex-wrap gap-2">
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="미성년자도 스마트스토어를 개설할 수 있나요?">미성년자도 스마트스토어를 개설할 수 있나요?</button>
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="상품 등록은 어떤 순서로 하나요?">상품 등록은 어떤 순서로 하나요?</button>
                <button class="px-2.5 py-1.5 rounded-full border bg-white hover:bg-[#2DB400] hover:text-white text-sm transition-colors" data-quick-q="정산 주기/수수료는 어떻게 되나요?">정산 주기/수수료는 어떻게 되나요?</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Composer -->
        <form id="composer" class="mt-4 flex gap-2">
          <input id="message" class="flex-1 border rounded-xl px-4 py-3" placeholder="질문을 입력하세요. 예) 미성년자도 판매 회원 등록이 가능한가요?" autocomplete="off" maxlength="500" />
          <button class="px-5 py-3 rounded-xl bg-[#2DB400] text-white font-medium">보내기</button>
        </form>

      </div>
    </main>

    <footer class="border-t bg-white">
      <div class="mx-auto max-w-3xl px-4 py-3 text-xs text-gray-500 text-center">
        네이버 스마트스토어 FAQ 챗봇 • AI 기반 지능형 상담 서비스
      </div>
    </footer>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('composer');
    const inputEl = document.getElementById('message');

    // 고정된 API Base URL 사용
    const API_BASE = 'http://localhost:8000';

    let conversationId = localStorage.getItem('conversationId');
    if (!conversationId) {
      conversationId = crypto.randomUUID();
      localStorage.setItem('conversationId', conversationId);
    }

    // Quick question buttons handler (for both initial and dynamic buttons)
    function setupQuickButtons() {
      document.querySelectorAll('[data-quick-q]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const q = btn.getAttribute('data-quick-q') || '';
          if (!q) return;
          inputEl.value = q;
          formEl.dispatchEvent(new Event('submit'));
        });
      });
    }
    
    // Setup initial quick buttons
    setupQuickButtons();

    function appendBubble(role, html) {
      const wrap = document.createElement('div');
      // ✅ w-full + items-end 로 수직 하단 정렬, gap 유지
      wrap.className = 'msg flex w-full items-end gap-3';

      const avatar = document.createElement('div');
      avatar.className = 'shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white';

      const body = document.createElement('div');
      body.className = 'rounded-2xl px-4 py-2 max-w-[85%] break-words';

      if (role === 'user') {
        // ✅ 오른쪽 고정: 전체 래퍼를 오른쪽으로 밀착 + 역방향 플렉스
        wrap.classList.add('ml-auto', 'flex-row-reverse'); // (justify-end 제거)
        avatar.textContent = 'U';
        avatar.classList.add('bg-gray-800');
        body.classList.add('bg-gray-100');
      } else {
        avatar.textContent = 'B';
        avatar.classList.add('bg-[#2DB400]');
        body.classList.add('bg-green-50');
      }

      const p = document.createElement('p');
      p.className = 'leading-relaxed break-words';
      if (role === 'user') p.classList.add('text-right');
      p.innerHTML = html || '';
      body.appendChild(p);

      // ✅ 사용자일 때: 버블을 먼저, 아바타를 나중에 추가 → row-reverse에서 버블이 우측 끝에 고정
      if (role === 'user') {
        wrap.appendChild(body);
        wrap.appendChild(avatar);
      } else {
        wrap.appendChild(avatar);
        wrap.appendChild(body);
      }

      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
      return { wrap, body, p };
    }

    function sanitize(text) {
      // Basic escape for HTML special chars
      return text
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function extractBlocks(text) {
      // Extract optional <followups> and <citations> custom blocks from the final text
      const followRe = /<followups>[\s\S]*?<\/followups>/i;
      const citsRe = /<citations>[\s\S]*?<\/citations>/i;

      const fMatch = text.match(followRe);
      const cMatch = text.match(citsRe);

      let main = text.replace(followRe, '').replace(citsRe, '').trim();
      let followups = [];
      let citations = [];

      if (fMatch) {
        const lines = fMatch[0]
          .replace(/<\/?followups>/gi, '')
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);
        // keep only bullet lines
        followups = lines
          .filter(s => s.startsWith('-'))
          .map(s => s.replace(/^-[\s]*/, ''))
          .filter(Boolean)
          .slice(0, 4);
      }

      if (cMatch) {
        const lines = cMatch[0]
          .replace(/<\/?citations>/gi, '')
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);
        citations = lines
          .filter(s => s.startsWith('-'))
          .map(s => {
            // format: - (제목) (URL)
            const m = s.match(/^-[\s]*\((.*?)\)[\s]*\((https?:[^\s)]+)\)/);
            if (m) return { title: m[1], url: m[2] };
            return null;
          })
          .filter(Boolean)
          .slice(0, 3);
      }

      return { main, followups, citations };
    }

    async function sendMessage(ev) {
      ev.preventDefault();
      const msg = inputEl.value.trim();
      if (!msg) return;

      // Show user bubble
      appendBubble('user', sanitize(msg));
      inputEl.value = '';

      // Create assistant bubble placeholder with loading message
      const { body, p } = appendBubble('assistant', '답변을 생성하고 있습니다... 잠시만 기다려주세요.');
      const extra = document.createElement('div');
      extra.className = 'text-xs text-gray-600 mt-2 space-y-2';
      body.appendChild(extra);

      const res = await fetch(`${API_BASE}/chat/stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ conversation_id: conversationId, message: msg })
      });

      if (!res.ok || !res.body) {
        p.innerText = '서버 오류가 발생했습니다. 백엔드 상태를 확인해주세요.';
        return;
      }

      // Clear loading message when streaming starts
      p.textContent = '';

      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let buffer = '';
      let fullText = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        // SSE chunks are separated by \n\n
        const parts = buffer.split('\n\n');
        buffer = parts.pop() || '';
        for (const part of parts) {
          const lines = part.split('\n');
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const payload = JSON.parse(line.slice(6));
                if (payload && payload.type === 'token') {
                  fullText += payload.content || '';
                  p.textContent = fullText; // Live update
                  chatEl.scrollTop = chatEl.scrollHeight;
                }
              } catch {}
            }
          }
        }
      }

      // Post-process blocks: followups & citations
      const { main, followups, citations } = extractBlocks(fullText);
      p.textContent = main || fullText; // strip custom blocks from final text

      // Render followups
      if (followups.length) {
        const wrap = document.createElement('div');
        wrap.className = 'flex flex-wrap gap-2';
        for (const f of followups) {
          const btn = document.createElement('button');
          btn.className = 'px-2.5 py-1.5 rounded-full border bg-white hover:bg-gray-50';
          btn.textContent = f;
          btn.addEventListener('click', () => {
            inputEl.value = f;
            formEl.dispatchEvent(new Event('submit'));
          });
          wrap.appendChild(btn);
        }
        extra.appendChild(wrap);
      }

      // Render citations
      if (citations.length) {
        const list = document.createElement('ul');
        list.className = 'list-disc ml-5';
        for (const c of citations) {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = c.url;
          a.target = '_blank';
          a.rel = 'noreferrer';
          a.className = 'text-blue-700 underline';
          a.textContent = c.title || c.url;
          li.appendChild(a);
          list.appendChild(li);
        }
        const title = document.createElement('div');
        title.className = 'mt-2 font-medium';
        title.textContent = '참고:';
        extra.appendChild(title);
        extra.appendChild(list);
      }
    }

    formEl.addEventListener('submit', sendMessage);
  </script>
</body>
</html>
